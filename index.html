<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GameGeek</title>

  <link rel="stylesheet" href="gamegeek.css" />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ®</text></svg>">

  <style>
    #slot-center { position: relative; }

    /* æ–°å¢ï¼šåŒ…ä½éŠæˆ² + overlay çš„å®¹å™¨ */
    #game-wrapper {
      position: relative;
      display: inline-block; /* å¯¬é«˜è·Ÿè‘— iframe èµ° */
    }

    /* ç–Šåœ¨ iframe ä¸Šçš„çµ‚ç«¯æ©Ÿè¼¸å‡ºå±¤ï¼ˆä¸æ“‹æ“ä½œï¼‰ */
    #terminal {
      position: absolute;
      inset: 0;
      padding: 8px 10px;
      background: transparent;

      color: #00ff66;
      font-family: "JetBrains Mono", "Fira Code", Menlo, Consolas, monospace;
      font-size: 11px;
      line-height: 1.4;

      pointer-events: none; /* ä¸æ“‹ iframe / launcher / settings */
      z-index: 10;
      overflow-y: hidden;
    }

    /* âœ… terminal é è¨­éš±è—ï¼šç”± develop mode æ§åˆ¶ */
    #terminal.hidden { display: none !important; }

    /* è¦†è“‹å¼è¼‰å…¥ä»‹é¢ï¼ˆæœƒæ“‹ä½ä¸­é–“æ­£æ–¹å½¢å€åŸŸï¼‰ */
    #launcher {
      position: absolute;
      inset: 0;
      background: #f0f0f0;
      z-index: 20;
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 12px;
      pointer-events: auto;
    }

    /* âœ… è¦†è“‹å¼è¨­å®šä»‹é¢ï¼ˆåŒ launcher é¢¨æ ¼ï¼‰ */
    #settings-panel{
      position: absolute;
      inset: 0;
      background: #f0f0f0;
      z-index: 21; /* æ¯” launcher é«˜ä¸€é»ï¼Œé¿å…åŒæ™‚é–‹æ™‚ç–ŠéŒ¯ */
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 12px;
      pointer-events: auto;
    }

    .hidden { display: none !important; }

    .launcher-topbar,
    .settings-topbar{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    #game-url{
      flex: 1 1 auto;
      height: 34px;
      padding: 0 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    #load-btn, #close-btn,
    #settings-close-btn{
      height: 34px;
      padding: 0 12px;
      border-radius: 6px;
    }

    /* âœ… SS ä¸»é  iframe å®¹å™¨ */
    .launcher-body{
      flex: 1 1 auto;
      min-height: 0;            /* è®“ iframe èƒ½åœ¨ flex è£¡æ­£ç¢ºç¸®æ”¾ */
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      overflow: hidden;
      background: #f0f0f0;
    }
    #ss-home{
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      background: #f0f0f0;
    }

    /* launcher/è¨­å®šé¢æ¿åº•éƒ¨æç¤º */
    .launcher-footnote,
    .settings-footnote{
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }

    /* âœ… Settings å…§å®¹å€ */
    .settings-body{
      background: #ffffff;
      border: 1px solid #cfcfcf;
      border-radius: 10px;
      padding: 12px;
    }
    .settings-row{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 14px;
      color: #222;
    }
    .settings-row input[type="checkbox"]{
      width: 18px;
      height: 18px;
    }
  </style>
</head>

<body class="landscape">
<div id="shell">
  <div id="slot-left"></div>

  <div id="slot-center">
    <div id="game-wrapper">
      <iframe id="game" src="about:blank" frameborder="0" scrolling="no" allowfullscreen></iframe>

      <!-- çµ‚ç«¯æ©Ÿï¼šé¡¯ç¤ºæŒ‰éˆ•äº‹ä»¶ï¼ˆé è¨­éš±è—ï¼‰ -->
      <div id="terminal" class="hidden" aria-hidden="true"></div>

      <!-- è¦†è“‹å±¤ï¼šè¼¸å…¥ç¶²å€ + è¼‰å…¥ + SS ä¸»é  -->
      <div id="launcher" class="hidden" aria-hidden="true">
        <div class="launcher-topbar">
          <input id="game-url" type="text" placeholder="è²¼ä¸ŠéŠæˆ²ç¶²å€ï¼ˆå»ºè­°å« /index.htmlï¼‰" />
          <button id="load-btn" class="gbtn">è¼‰å…¥</button>
          <button id="close-btn" class="gbtn">âœ•</button>
        </div>

        <!-- âœ… åŸ launcher-hint æ”¹æˆ iframeï¼šå›ºå®šæ”¾ SS ä¸»é  -->
        <div class="launcher-body">
          <iframe id="ss-home"
                  src="https://strategy-space.vercel.app/index.html"
                  title="StrategySpace Home"></iframe>
        </div>

        <div class="launcher-footnote">
          é» SS çš„ Play æœƒæŠŠç¶²å€é€å›é€™è£¡ï¼Œç„¶å¾Œä½ å†æŒ‰ã€Œè¼‰å…¥ã€ç¢ºå®šé€²å…¥éŠæˆ²ã€‚
        </div>
      </div>

      <!-- âœ… è¦†è“‹å±¤ï¼šSettings -->
      <div id="settings-panel" class="hidden" aria-hidden="true">
        <div class="settings-topbar">
          <div style="flex:1 1 auto; font-weight:700; color:#333;">Settings</div>
          <button id="settings-close-btn" class="gbtn">âœ•</button>
        </div>

        <div class="settings-body">
          <label class="settings-row">
            <input id="dev-toggle" type="checkbox" />
            <span>Develop modeï¼ˆé¡¯ç¤º terminalï¼‰</span>
          </label>
        </div>

        <div class="settings-footnote">
          å‹¾é¸å¾Œæ‰æœƒé¡¯ç¤ºç¶ è‰² terminalã€‚ä¹‹å¾Œæ›´å¤š GG è¨­å®šé …æœƒåŠ åœ¨é€™è£¡ã€‚
        </div>
      </div>

    </div>
  </div>

  <div id="slot-right"></div>
  <div id="slot-bottom"></div>
</div>

<!-- LeafLune Panelï¼ˆlogo + D-Padï¼‰ -->
<section id="panel-leaf" class="panel">
  <div class="brand">
    <img src="leaflune_emoji.png" alt="LeafLune logo">
    <span>LeafLune</span>
  </div>

  <div class="dpad control-block">
    <button class="gbtn" data-key="up"    style="grid-area: up;">â†‘</button>
    <button class="gbtn" data-key="left"  style="grid-area: left;">â†</button>
    <button class="gbtn" data-key="right" style="grid-area: right;">â†’</button>
    <button class="gbtn" data-key="down"  style="grid-area: down;">â†“</button>
  </div>

  <div class="panel-foot">
    <button class="gbtn utility-btn" title="Start">â–·</button>
    <!-- é€™é¡†ç”¨ä¾†æ‰“é–‹è¦†è“‹å±¤ï¼ˆSS launcherï¼‰ -->
    <button id="menu-btn" class="gbtn utility-btn" title="Select">â˜°</button>
  </div>
</section>

<!-- GameGeek Panelï¼ˆæ–‡å­— + 1~4 + å…¨è¢å¹•ï¼‰ -->
<section id="panel-geek" class="panel">
  <div class="brand">
    <span>GameGeek</span>
    <span aria-hidden="true">ğŸ®</span>
  </div>

  <div class="actions control-block">
    <button class="gbtn" data-key="btn1" style="grid-area: btn1;">1</button>
    <button class="gbtn" data-key="btn2" style="grid-area: btn2;">2</button>
    <button class="gbtn" data-key="btn3" style="grid-area: btn3;">3</button>
    <button class="gbtn" data-key="btn4" style="grid-area: btn4;">4</button>
  </div>

  <div class="panel-foot">
    <!-- âœ… æ”¹æˆæœ‰ idï¼šç”¨ä¾†æ‰“é–‹ settings -->
    <button id="settings-btn" class="gbtn utility-btn" title="Set">âš™</button>
    <button id="fullscreen-btn" class="gbtn utility-btn" title="å…¨è¢å¹•">â›¶</button>
  </div>
</section>

<script src="gg_rwd.js"></script>

<script>
  const fsBtn       = document.getElementById('fullscreen-btn');
  const menuBtn     = document.getElementById('menu-btn');
  const settingsBtn = document.getElementById('settings-btn');

  const gameFrame = document.getElementById('game');
  const terminal  = document.getElementById('terminal');

  const launcher  = document.getElementById('launcher');
  const urlInput  = document.getElementById('game-url');
  const loadBtn   = document.getElementById('load-btn');
  const closeBtn  = document.getElementById('close-btn');

  const settingsPanel = document.getElementById('settings-panel');
  const settingsClose = document.getElementById('settings-close-btn');
  const devToggle     = document.getElementById('dev-toggle');

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
  }
  fsBtn.addEventListener('click', toggleFullscreen);

  layout(); // ä½ åŸæœ¬çš„ responsive/ç½®ä¸­ sizing é‚è¼¯

  // ====== Terminal ======
  function nowStamp() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    const ms = String(d.getMilliseconds()).padStart(3, '0');
    return `${hh}:${mm}:${ss}.${ms}`;
  }

  function printTerminal(text, showTime = true) {
    // âœ… è‹¥ terminal éš±è—ï¼Œä»å¯ä¿ç•™ logï¼ˆåªæ˜¯ä¸é¡¯ç¤ºï¼‰
    // è‹¥ä½ æƒ³å®Œå…¨ä¸è¨˜éŒ„ï¼Œå¯æ”¹æˆï¼šif (terminal.classList.contains('hidden')) return;
    if (!terminal) return;
    const line = document.createElement('div');
    line.textContent = showTime ? `[${nowStamp()}] ${text}` : `${text}`;
    terminal.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  }

  function ggEventText(player, btnID, state) {
    return `{ id:${btnID}, s:"${state}" }`;
  }

  // ====== GG btnID å›ºå®šè¡¨ï¼ˆv1.0ï¼‰=====
  // 0: none
  // 1~4: åŠŸèƒ½éµ
  // 5~8: ä¸Šå·¦ä¸‹å³ï¼ˆWASD / IJKLï¼‰
  const btnIDMap = {
    btn1: 1, btn2: 2, btn3: 3, btn4: 4,
    up: 5, left: 6, down: 7, right: 8
  };

  function sendGGEvent(player, btnID, state) {
    if (!gameFrame || !gameFrame.contentWindow) return;
    gameFrame.contentWindow.postMessage(
            { type: "gg_event", player, btnID, state },
            "*"
    );
  }

  // ====== Launcher ======
  function showLauncher() {
    // äº’æ–¥ï¼šé–‹ launcher å°±é—œ settings
    hideSettings();

    launcher.classList.remove('hidden');
    launcher.setAttribute('aria-hidden', 'false');
    // é å¡«ç›®å‰ srcï¼ˆæ–¹ä¾¿ä½ æ”¹ï¼‰
    urlInput.value = gameFrame.src || '';
    setTimeout(() => urlInput.focus(), 0);
  }

  function hideLauncher() {
    launcher.classList.add('hidden');
    launcher.setAttribute('aria-hidden', 'true');
  }

  function normalizeUrl(u) {
    u = (u || '').trim();
    if (!u) return '';
    if (u.endsWith('.html')) return u;
    if (u.endsWith('/')) return u + 'index.html';
    return u + '/index.html';
  }

  function loadGameUrl() {
    const u = normalizeUrl(urlInput.value);
    if (!u) return;
    gameFrame.src = u;
    hideLauncher();
    printTerminal(`loaded: ${u}`, true);
    // è¼‰å…¥éŠæˆ²å¾Œï¼šä¾ develop mode æ±ºå®š terminal æ˜¯å¦é¡¯ç¤º
    setDevelopMode(devToggle.checked, false);
  }

  menuBtn.addEventListener('click', () => {
    if (launcher.classList.contains('hidden')) showLauncher();
    else hideLauncher();
  });

  closeBtn.addEventListener('click', hideLauncher);
  loadBtn.addEventListener('click', loadGameUrl);

  urlInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadGameUrl();
    if (e.key === 'Escape') hideLauncher();
  });

  // âœ… æ¥æ”¶ SS ä¸»é çš„é¸æ“‡ï¼šåªå¯«å…¥ç¶²å€åˆ—ï¼Œä¸è‡ªå‹•è¼‰å…¥
  const ALLOWED_SS_ORIGIN = "https://strategy-space.vercel.app";

  window.addEventListener("message", (ev) => {
    const d = ev.data;
    if (!d || typeof d !== "object") return;

    // åªæ¥å— SS ä¾†æºï¼ˆé¿å…äº‚å¡ï¼‰
    if (ev.origin !== ALLOWED_SS_ORIGIN) return;

    if (d.type === "ss_open" && typeof d.url === "string") {
      const u = normalizeUrl(d.url);
      urlInput.value = u;

      // è‹¥ launcher æ²’æ‰“é–‹ï¼Œå¹«ä½ æ‰“é–‹ï¼ˆä½ æ‰çœ‹å¾—åˆ°ç¶²å€åˆ—å·²è¢«å¡«å…¥ï¼‰
      if (launcher.classList.contains("hidden")) showLauncher();

      printTerminal(`SS selected: ${u} (waiting for load)`, true);
    }
  });

  // ====== Settings (Develop Mode) ======
  function showSettings(){
    // äº’æ–¥ï¼šé–‹ settings å°±é—œ launcher
    hideLauncher();

    settingsPanel.classList.remove('hidden');
    settingsPanel.setAttribute('aria-hidden', 'false');
  }
  function hideSettings(){
    settingsPanel.classList.add('hidden');
    settingsPanel.setAttribute('aria-hidden', 'true');
  }

  function setDevelopMode(on, save = true){
    if (on) terminal.classList.remove('hidden');
    else terminal.classList.add('hidden');

    if (save) localStorage.setItem('gg_develop_mode', on ? '1' : '0');
  }

  // åˆå§‹ï¼šè®€ localStorageï¼ˆé è¨­é—œï¼‰
  (function initDevelopMode(){
    const saved = localStorage.getItem('gg_develop_mode');
    const on = saved === '1';
    devToggle.checked = on;
    setDevelopMode(on, false);
  })();

  settingsBtn.addEventListener('click', () => {
    if (settingsPanel.classList.contains('hidden')) showSettings();
    else hideSettings();
  });
  settingsClose.addEventListener('click', hideSettings);

  devToggle.addEventListener('change', () => {
    setDevelopMode(devToggle.checked, true);
  });

  // ====== ç¶å®šæ‰€æœ‰ data-key æŒ‰éˆ•ï¼šå°å‡º + é€å‡º gg_event ======
  const padButtons = document.querySelectorAll('button[data-key]');
  const currentPlayer = 0;

  padButtons.forEach(btn => {
    const key = btn.dataset.key;
    const btnID = btnIDMap[key] ?? 0;

    btn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      if (btn.setPointerCapture) btn.setPointerCapture(e.pointerId);

      printTerminal(ggEventText(currentPlayer, btnID, "down"), false);
      sendGGEvent(currentPlayer, btnID, "down");
    });

    const end = (e) => {
      e.preventDefault();
      try { if (btn.releasePointerCapture) btn.releasePointerCapture(e.pointerId); } catch (err) {}

      printTerminal(ggEventText(currentPlayer, btnID, "up"), false);
      sendGGEvent(currentPlayer, btnID, "up");
    };

    btn.addEventListener('pointerup', end);
    btn.addEventListener('pointercancel', end);
  });
</script>
</body>
</html>
