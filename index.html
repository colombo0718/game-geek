<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GameGeek</title>

  <link rel="stylesheet" href="gamegeek.css" />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ®</text></svg>">

  <style>
    #slot-center { position: relative; }

    /* æ–°å¢ï¼šåŒ…ä½éŠæˆ² + overlay çš„å®¹å™¨ */
    #game-wrapper {
      position: relative;
      display: inline-block; /* å¯¬é«˜è·Ÿè‘— iframe èµ° */
    }

    /* ç–Šåœ¨ iframe ä¸Šçš„çµ‚ç«¯æ©Ÿè¼¸å‡ºå±¤ï¼ˆä¸æ“‹æ“ä½œï¼‰ */
    #terminal {
      position: absolute;
      inset: 0;
      padding: 8px 10px;
      background: transparent;

      color: #00ff66;
      font-family: "JetBrains Mono", "Fira Code", Menlo, Consolas, monospace;
      font-size: 11px;
      line-height: 1.4;

      pointer-events: none; /* ä¸æ“‹ iframe / launcher */
      z-index: 10;
      overflow-y: hidden;
    }

    /* è¦†è“‹å¼è¼‰å…¥ä»‹é¢ï¼ˆæœƒæ“‹ä½ä¸­é–“æ­£æ–¹å½¢å€åŸŸï¼‰ */
    #launcher {
      position: absolute;
      inset: 0;
      background: #f0f0f0;     /* ä½ è¦çš„ï¼šèˆ‡å¤–é¢ç›¸åŒçš„åº•è‰²ï¼ˆå¯ä¾ä½ å¤–åœˆå¯¦è‰²å†èª¿ï¼‰ */
      z-index: 20;
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 12px;
      pointer-events: auto;
    }

    .hidden { display: none !important; }

    .launcher-topbar{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    #game-url{
      flex: 1 1 auto;
      height: 34px;
      padding: 0 10px;
      border: 1px solid #bbb;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    #load-btn, #close-btn{
      height: 34px;
      padding: 0 12px;
      border-radius: 6px;
    }
    .launcher-hint{
      font-size: 12px;
      color: #666;
      line-height: 1.5;
    }
  </style>
</head>

<body class="landscape">
<div id="shell">
  <div id="slot-left"></div>

  <div id="slot-center">
    <div id="game-wrapper">
      <iframe id="game" src="about:blank" frameborder="0" scrolling="no" allowfullscreen></iframe>

      <!-- çµ‚ç«¯æ©Ÿï¼šé¡¯ç¤ºæŒ‰éˆ•äº‹ä»¶ -->
      <div id="terminal" aria-hidden="true"></div>

      <!-- è¦†è“‹å±¤ï¼šè¼¸å…¥ç¶²å€ + è¼‰å…¥ -->
      <div id="launcher" class="hidden" aria-hidden="true">
        <div class="launcher-topbar">
          <input id="game-url" type="text" placeholder="è²¼ä¸ŠéŠæˆ²ç¶²å€ï¼ˆå»ºè­°å« /index.htmlï¼‰" />
          <button id="load-btn" class="gbtn">è¼‰å…¥</button>
          <button id="close-btn" class="gbtn">âœ•</button>
        </div>
        <div class="launcher-hint">
          ç¯„ä¾‹ï¼š https://strategy-space.vercel.app/voxel/santa-gifts/index.html<br>
          ï¼ˆä½ å·²æ±ºå®šç¿’æ…£åŠ  /index.htmlï¼›é€™è£¡ä¹Ÿæœ‰æœ€å°é˜²å‘†ï¼Œæ²’å¯«æœƒè‡ªå‹•è£œï¼‰
        </div>
      </div>
    </div>
  </div>

  <div id="slot-right"></div>
  <div id="slot-bottom"></div>
</div>

<!-- LeafLune Panelï¼ˆlogo + D-Padï¼‰ -->
<section id="panel-leaf" class="panel">
  <div class="brand">
    <img src="leaflune_emoji.png" alt="LeafLune logo">
    <span>LeafLune</span>
  </div>

  <div class="dpad control-block">
    <button class="gbtn" data-key="up"    style="grid-area: up;">â†‘</button>
    <button class="gbtn" data-key="left"  style="grid-area: left;">â†</button>
    <button class="gbtn" data-key="right" style="grid-area: right;">â†’</button>
    <button class="gbtn" data-key="down"  style="grid-area: down;">â†“</button>
  </div>

  <div class="panel-foot">
    <button class="gbtn utility-btn" title="Start">â–·</button>
    <!-- é€™é¡†ç”¨ä¾†æ‰“é–‹è¦†è“‹å±¤ -->
    <button id="menu-btn" class="gbtn utility-btn" title="Select">â˜°</button>
  </div>
</section>

<!-- GameGeek Panelï¼ˆæ–‡å­— + 1~4 + å…¨è¢å¹•ï¼‰ -->
<section id="panel-geek" class="panel">
  <div class="brand">
    <span>GameGeek</span>
    <span aria-hidden="true">ğŸ®</span>
  </div>

  <div class="actions control-block">
    <button class="gbtn" data-key="btn1" style="grid-area: btn1;">1</button>
    <button class="gbtn" data-key="btn2" style="grid-area: btn2;">2</button>
    <button class="gbtn" data-key="btn3" style="grid-area: btn3;">3</button>
    <button class="gbtn" data-key="btn4" style="grid-area: btn4;">4</button>
  </div>

  <div class="panel-foot">
    <button class="gbtn utility-btn" title="Set">âš™</button>
    <button id="fullscreen-btn" class="gbtn utility-btn" title="å…¨è¢å¹•">â›¶</button>
  </div>
</section>

<script src="gg_rwd.js"></script>

<script>
  const fsBtn     = document.getElementById('fullscreen-btn');
  const menuBtn   = document.getElementById('menu-btn');

  const gameFrame = document.getElementById('game');
  const terminal  = document.getElementById('terminal');

  const launcher  = document.getElementById('launcher');
  const urlInput  = document.getElementById('game-url');
  const loadBtn   = document.getElementById('load-btn');
  const closeBtn  = document.getElementById('close-btn');

  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      const el = document.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }
  }
  fsBtn.addEventListener('click', toggleFullscreen);

  layout(); // ä½ åŸæœ¬çš„ responsive/ç½®ä¸­ sizing é‚è¼¯

  // ====== Terminal ======

  function nowStamp() {
    const d = new Date();
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    const ms = String(d.getMilliseconds()).padStart(3, '0');
    return `${hh}:${mm}:${ss}.${ms}`;
  }

  // åœ¨ terminal è£¡åŠ ä¸€è¡Œ logï¼ˆå¯é¸æ™‚é–“æˆ³ï¼‰
  function printTerminal(text, showTime = true) {
    if (!terminal) return;
    const line = document.createElement('div');
    line.textContent = showTime ? `[${nowStamp()}] ${text}` : `${text}`;
    terminal.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  }

  // ä½ è¦çš„ç°¡åŒ–è¼¸å‡ºï¼šåªé¡¯ç¤º id + s
  function ggEventText(player, btnID, state) {
    return `{ id:${btnID}, s:"${state}" }`;
  }

  // ====== GG btnID å›ºå®šè¡¨ï¼ˆv1.0ï¼‰=====
  // 0: none
  // 1~4: åŠŸèƒ½éµ
  // 5~8: ä¸Šå·¦ä¸‹å³ï¼ˆWASD / IJKLï¼‰
  const btnIDMap = {
    btn1: 1, btn2: 2, btn3: 3, btn4: 4,
    up: 5, left: 6, down: 7, right: 8
  };

  // ====== postMessage: çœŸçš„æŠŠæ§åˆ¶è¨Šè™Ÿé€çµ¦ iframe ======
  function sendGGEvent(player, btnID, state) {
    if (!gameFrame || !gameFrame.contentWindow) return;

    // çœŸæ­£é€å‡ºå»çš„å”å®šï¼šå®Œæ•´ gg_event
    gameFrame.contentWindow.postMessage(
            { type: "gg_event", player, btnID, state },
            "*"
    );
  }

  // ====== Launcherï¼ˆè¦†è“‹å¼è¼‰å…¥ä»‹é¢ï¼‰=====
  function showLauncher() {
    launcher.classList.remove('hidden');
    launcher.setAttribute('aria-hidden', 'false');
    // é å¡«ç›®å‰ srcï¼ˆæ–¹ä¾¿ä½ æ”¹ï¼‰
    urlInput.value = gameFrame.src || '';
    setTimeout(() => urlInput.focus(), 0);
  }

  function hideLauncher() {
    launcher.classList.add('hidden');
    launcher.setAttribute('aria-hidden', 'true');
  }

  function normalizeUrl(u) {
    u = (u || '').trim();
    if (!u) return '';

    // æœ€å°é˜²å‘†ï¼šä½ å°‘å¯« /index.html æ™‚ï¼Œè‡ªå‹•è£œä¸Š
    if (u.endsWith('.html')) return u;
    if (u.endsWith('/')) return u + 'index.html';
    return u + '/index.html';
  }

  function loadGameUrl() {
    const u = normalizeUrl(urlInput.value);
    if (!u) return;
    gameFrame.src = u;
    hideLauncher();
    printTerminal(`loaded: ${u}`, true);
  }

  menuBtn.addEventListener('click', () => {
    if (launcher.classList.contains('hidden')) showLauncher();
    else hideLauncher();
  });

  closeBtn.addEventListener('click', hideLauncher);
  loadBtn.addEventListener('click', loadGameUrl);

  urlInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') loadGameUrl();
    if (e.key === 'Escape') hideLauncher();
  });

  // ====== ç¶å®šæ‰€æœ‰ data-key æŒ‰éˆ•ï¼šå°å‡º + é€å‡º gg_event ======
  const padButtons = document.querySelectorAll('button[data-key]');

  // ç›®å‰å…ˆå›ºå®š player=0ï¼Œä¹‹å¾Œä½ åš 2P å†æ”¹æˆå¯åˆ‡æ›è®Šæ•¸
  const currentPlayer = 0;

  padButtons.forEach(btn => {
    const key = btn.dataset.key;
    const btnID = btnIDMap[key] ?? 0;

    btn.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      if (btn.setPointerCapture) btn.setPointerCapture(e.pointerId);

      // çµ‚ç«¯æ©Ÿé¡¯ç¤ºï¼ˆä½ è¦ç°¡åŒ–ï¼Œå…ˆä¸é¡¯ç¤ºæ™‚é–“ï¼‰
      printTerminal(ggEventText(currentPlayer, btnID, "down"), false);

      // çœŸæ­£é€å‡º
      sendGGEvent(currentPlayer, btnID, "down");
    });

    const end = (e) => {
      e.preventDefault();
      try { if (btn.releasePointerCapture) btn.releasePointerCapture(e.pointerId); } catch (err) {}

      printTerminal(ggEventText(currentPlayer, btnID, "up"), false);
      sendGGEvent(currentPlayer, btnID, "up");
    };

    btn.addEventListener('pointerup', end);
    btn.addEventListener('pointercancel', end);
  });
</script>
</body>
</html>
